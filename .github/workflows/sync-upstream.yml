name: Sync with Upstream

on:
  schedule:
    # Run daily at 2 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Allow manual trigger

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: release
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote
        run: |
          git remote add upstream https://github.com/PokemonTCG/pokemon-tcg-data.git || true
          git remote set-url upstream https://github.com/PokemonTCG/pokemon-tcg-data.git

      - name: Fetch upstream changes
        run: git fetch upstream

      - name: Check for updates
        id: check
        run: |
          # Get the latest commit from upstream main/master
          UPSTREAM_BRANCH="master"
          if git rev-parse --verify upstream/master >/dev/null 2>&1; then
            UPSTREAM_BRANCH="master"
          fi

          UPSTREAM_COMMIT=$(git rev-parse upstream/$UPSTREAM_BRANCH)
          LOCAL_COMMIT=$(git rev-parse HEAD)

          echo "upstream_branch=$UPSTREAM_BRANCH" >> $GITHUB_OUTPUT
          echo "upstream_commit=$UPSTREAM_COMMIT" >> $GITHUB_OUTPUT
          echo "local_commit=$LOCAL_COMMIT" >> $GITHUB_OUTPUT

          if [ "$UPSTREAM_COMMIT" != "$LOCAL_COMMIT" ]; then
            echo "has_updates=true" >> $GITHUB_OUTPUT
            echo "Updates available from upstream"
          else
            echo "has_updates=false" >> $GITHUB_OUTPUT
            echo "Already up to date with upstream"
          fi

      - name: Merge upstream changes
        if: steps.check.outputs.has_updates == 'true'
        run: |
          UPSTREAM_BRANCH=${{ steps.check.outputs.upstream_branch }}

          # Try to merge upstream changes
          if git merge upstream/$UPSTREAM_BRANCH --no-edit; then
            echo "Successfully merged upstream changes"
            git push origin master
          else
            echo "Merge conflict detected. Creating an issue for manual resolution."
            git merge --abort
            exit 1
          fi

      - name: Create issue on merge conflict
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸ”„ Upstream Sync Conflict - Manual Resolution Required',
              body: `The automated sync with the upstream repository encountered a merge conflict.

              **Action Required:**
              Please manually sync with the upstream repository and resolve any conflicts.

              **Steps:**
              1. \`git fetch upstream\`
              2. \`git merge upstream/master\` (or \`upstream/main\`)
              3. Resolve conflicts
              4. \`git push origin main\`

              **Upstream Repository:** https://github.com/PokemonTCG/pokemon-tcg-data

              Once resolved, the changes will automatically propagate to the release branch.`,
              labels: ['upstream-sync', 'manual-action-required']
            });
            console.log('Created issue:', issue.data.number);

      - name: Trigger release merge
        if: steps.check.outputs.has_updates == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'merge-to-release.yml',
              ref: 'main'
            });
